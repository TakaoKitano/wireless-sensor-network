<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>wireless temperature sensors</title>
  <script src="d3.v3.min.js" charset="utf-8"></script>
  <script src="c3/c3.js"></script>
  <script type="text/javascript" src="jquery-2.1.4.js"></script>
  <script type="text/javascript" src="jquery-ui.js"></script>
  <link rel="stylesheet" type="text/css" href="c3/c3.css">
  <link rel="stylesheet" href="jquery-ui.css">
  <style type="text/css">

    p { color: #000000; }
    p.red { color: #ff0000; }
    p.black { color: #000000; }

</style>
</head>
<body>
  <script type="text/javascript">

    function displayTemperature(data) {
      //
      // data should be an object like this:
      // {
      //   1459423312:           // epoch int (seconds since 1970/1/1),
      //   { 
      //     "49B3":{             //  nodename string
      //       "time": 1461215944,
      //       "temperature": 19.56,
      //       "datetime": "2016-04-21 14:19:04",
      //       "signal": 132,
      //       "route": 7,
      //       "battery": 3340
      //       "route"2: 7         //  routes int
      //      },
      //      ...
      //    }
      // }
      //
      // we are going to convert the data to tempdata format
      //
      // rows: [
      //   ['time', nodename1, nodename2, ...],
      //   [ time, temperature1, temperature2,...],
      //   ...
      // ]
      //
      var get_rows = function(data) {
	  var rows = []; 
	  rows.push( (function() {
	    var a = ['time'];
	    $.each(nodes, function(nodename) {
	      a[nodes[nodename]['index']] = nodes[nodename]['name'];
	    });
	    return a;
	  })());

	  $.each(data, function(key, obj) {
	    var a = [new Date(parseInt(key) * 1000)];
	    $.each(nodes, function(nodename) {
	      a[nodes[nodename]['index']] = null;
	    });
	    $.each(obj, function(nodename, values) {
	      a[nodes[nodename]['index']] = values['temperature'];
	    });
            rows.push(a);
	  });
          return rows;
      };
      var sFormat = "%H:%M";
      var chart = c3.generate({
        bindto: '#chart',
        data: {
          rows: get_rows(data),
          x: 'time'
        },
        size: {
          height: 480
        },
        axis: {
          x: {
            localtime:true,
            type:'timeseries',
            tick:{
              format: sFormat,
              fit: false,
              centered: true
            }
          },
          y: {
            label: "temperature"
          }
        },
        grid: {
          y: {
	    show: true
	  },
          x: {
	    show: true
	  }
	},
        tooltip: {show: false},
        point: {show: false}
      });
    }

    var loadTemperature = function(url) {
      $.ajax({
        type: "GET",
        url: url,
        dataType: "json",
        success: function(data, dataType) {
           displayTemperature(data);
        },
        error: function(XMLHttpRequest, textStatus, errorThrown) {
           console.log("failed to load temperature.json:" + textStatus);
        }
      });
    };

    var loadCurrent = function() {
      $.ajax({
        type: "GET",
        url: "twelog/current.json",
        dataType: "json",
        success: function(data, dataType) {
           displayCurrent(data);
        },
        error: function(XMLHttpRequest, textStatus, errorThrown) {
           console.log("failed to load current.json:" + textStatus);
        }
      });
    };

    function displayCurrent(data) {
      console.log("loadCurrent");
      $.each(data, function(nodename, node) {
        var s = '<p><font size="5">' + nodes[nodename]['name'] + '   ' + node['temperature'] + '</font></p>';
        $("#"+nodename).append(s);
        if ( (node['time'] * 1000) + 1000 * 120 < (new Date).getTime()) {
	    s = '<p class="red"><small>' + node['datetime'] + ',\t' + node['battery'] + ',\t' + node['signal'] + ',\t' + node['route'] + '</small></p>';
        } else {
	    s = '<p class="black"><font size="1">' + nodename + ':' + node['datetime'] + ',\t' + node['battery'] + ',\t' + node['signal'] + ',\t' + node['route'] + '</font></p>';
        }
        $("#"+nodename).append(s);
      });
    }
  </script>

  <div id="current"></div>
  <table border="1">
      <tr>
        <td id="DFA5"></td>
        <td id="F2B6"></td>
        <td id="F390"></td>
      </tr>
      <tr>
        <td id="B356"></td>
        <td id="EEDB"></td>
        <td id="B0E9"></td>
      </tr>
      <tr>
        <td id="14A8"></td>
        <td id="1727"></td>
        <td id="15AC"></td>
      </tr>
      <tr>
        <td id="1618"></td>
        <td id="14AF"></td>
        <td id="1562"></td>
      </tr>
  </table>
  <div id="chart"></div>
  <p>Date: <input type="text" id="datepicker"></p>
  <script>
    var nodes = { 
                  "F2B6":{"index":1, "name":"3Fアトリウム"}, 
                  "DFA5":{"index":2, "name":"3Fバスルーム"},  
                  "F390":{"index":3, "name":"3Fベッドルーム"},
                  "B0E9":{"index":4, "name":"2Fリビング"},
                  "EEDB":{"index":5, "name":"2Fブリッジ"},
                  "B356":{"index":6, "name":"2Fダイニング"},
                  "15AC":{"index":7, "name":"1F書斎"},
                  "14A8":{"index":8, "name":"1F玄関"},
                  "1727":{"index":9, "name":"1F和室"},
                  "1618":{"index":10, "name":"EXT室外"},
                  "14AF":{"index":11, "name":"EXT和室床下"},
                  "1562":{"index":12, "name":"EXT倉庫床下"},
                };

    loadTemperature("twelog/temperature.json");
    loadCurrent();

    $( "#datepicker" ).datepicker({
          dateFormat: "yy-mm-dd",
          onSelect: function(dateText) {
            loadTemperature("logs/" + dateText + ".json");
          }
    });
  </script>
</body>
</html>
