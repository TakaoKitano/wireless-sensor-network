<html>
  <head>
  <script type="text/javascript" src="jquery-2.1.4.js"></script>
  <script type="text/javascript"
          src="https://www.google.com/jsapi?autoload={
            'modules':[{ 'name':'visualization', 'version':'1', 'packages':['corechart'] }] }">
  </script>
  <script type="text/javascript">

    function loadFile() {
      console.log("loadFile");
      $.ajax({
          type: "GET",
          url: "twelog/temperature.json",
          dataType: "json",
          success: function(data, dataType) {
             loadTemperature(data);
          },
          error: function(XMLHttpRequest, textStatus, errorThrown) {
             console.log("failed to load temperature.json:" + textStatus);
          }
      });
    }

    function drawChart(tempdata) {
      console.log("drawChart");
      var data = google.visualization.arrayToDataTable(tempdata);
      var options = {
         title: 'wireless temperature sensor',
          curveType: 'function',
          legend: { position: 'bottom' }
      };
      var chart = new google.visualization.LineChart(document.getElementById('curve_chart'));
      chart.draw(data, options);
    }

    function loadTemperature(data) {
      console.log("loadTemperature");
      //
      // tempdata is an array of array
      // the first array contains labels
      //
      var tempdata = (function() {
        var labels = ["time"];
        $.each(nodes, function(i, node) {
          labels.push(node["name"]);
        });
        return [labels];
      })();

      //
      // data should be an array of array, the inner array format is:
      // [
      //   0: 1459423312,  epoch int (seconds since 1970/1/1)
      //   1: "49B3",      nodename string
      //   2: 7,           routes int
      //   3: 102,         signal strength int
      //   4: 17.4,        temperature float
      //   5: 3330,        battery mV int
      // ]
      //
      // we are going to convert the data to tempdata format
      // 
      // [
      //   ["time", nodename0, nodename1, ...], // label
      //   [minite, node0 temerature, node1 temperature,...],
      //   [minite, node0 temerature, node1 temperature,...],
      //   ...
      // ]
      // where the first digit means minutes since 
      // the first entry of temperature.json
      // as temperature.json holds up to six hours of logs,
      // we will have 360 entries in tempobj
      //
      $.each(data, function(i, val) {
        var minute = Math.round((val[0] - data[0][0])/60.0);
        var latest = tempdata[tempdata.length-1];
        if (latest[0] != minute) {
          //
          // new array filled with undefined
          //
          var d = [minute];
          $.each(nodes, function() {
            d.push(undefined);
          });
          tempdata.push(d);
          latest = tempdata[tempdata.length-1];
        } 
        var nodename = val[1];
        var index = nodes[nodename]["index"];
        var te =  val[4] + nodes[nodename]["adjustment"];
        if (typeof latest[index] === "undefined") {
          latest[index] = te;
        } else {
          latest[index] = (latest[index] + te) / 2;
        }
      });

      //
      // finally draw the chart
      //
      drawChart(tempdata);
    }
  </script>
  </head>
  <body>
    <div id="curve_chart" style="width: 1200px; height: 800px"></div>
    <hr/>
    <div id="rawdata"></div>
  </body>
  <script type="text/javascript">
    console.log("script starts");
    var nodes = { 
                  "49B3":{"index":1, "name":"n-49B3", "adjustment":0.00}, 
                  "F2B6":{"index":2, "name":"n-F2B6", "adjustment":0.0}, 
                  "DFA5":{"index":3, "name":"n-DFA5", "adjustment":0.0},  
                  "B0E9":{"index":4, "name":"n-B0E9", "adjustment":0.0},
                  "EEDB":{"index":5, "name":"n-EEDB", "adjustment":-0.00},
                  "B356":{"index":6, "name":"n-B356", "adjustment":0.00},
                  //"F390":{"index":7, "name":"n-F390", "adjustment":0.0},
                };
    google.setOnLoadCallback(loadFile);
  </script>
</html>
